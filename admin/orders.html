<?php

$ordqry = "SELECT orderid, useremail, status, shippingaddress1,shippingaddress2,shippingcity,shippingstate,shippingpostal, paymenttype from orders  order by dateCreated DESC";

    if(!$stmt = $dbcon->prepare($ordqry)){
        die('Prepare Error : ('. $dbcon->errno .') '. $dbcon->error);
    }

    if(!$stmt->execute()){
        die('Error : ('. $dbcon->errno .') '. $dbcon->error);
    }

    $stmt->store_result();
    $stmt->bind_result($a,$b,$c,$d, $e, $f, $g, $h, $i);
    $curr_orders=[];
    while ($stmt->fetch()) {
            $ordprdqry = "SELECT order_products.productid, order_products.quantity, order_products.order_price, products.name, products.mainimg, products.customized FROM order_products inner join products  on order_products.productid=products.productid WHERE order_products.orderid=$a";

             $stmt1 = $dbcon->prepare($ordprdqry);
            if(!$stmt1->execute()){
                die('Error : ('. $dbcon->errno .') '. $dbcon->error);
            }
            $stmt1->store_result();
            $stmt1->bind_result($aa,$bb,$cc, $dd, $ee, $ff);
            $orderProducts =[];
            $desArr=[];
             $ordTotal = 0;
            while ($stmt1->fetch()) {
                $ordTotal = $ordTotal + $cc;
                if($ff == 1 ){
                    $design_qry = "SELECT elementid, leftPos,topPos,selectedImage,isProduct from customdesign where productid=$aa";

                    $stmt1a  = $dbcon->prepare($design_qry);
                    if(!$stmt1a ->execute()){
                        die('Error : ('. $dbcon->errno .') '. $dbcon->error);
                    }
                    $stmt1a ->store_result();
                    $stmt1a ->bind_result($a1,$b1, $c1, $d1, $e1);
                    while ($stmt1a ->fetch()) {
                        $desArr[] = ['elementid' => $a1, 'leftPos' => $b1, 'topPos' =>$c1, 'selectedImage' => $d1, 'isProduct' => $e1];
                    }
                    $stmt1a ->close();
              }

                $orderProducts[] = ['productid' => $aa, 'quantity' => $bb, 'order_price' => $cc, 'name' => $dd, 'mainimg' => $ee, 'customized' => $ff, 'ordTotal' => $ordTotal, 'design' => $desArr];
            }
            $stmt1->close();

        $curr_orders[] = ['orderid' => $a, 'useremail' => $b, 'status' => $c, 'shippingaddress1' => $d, 'shippingaddress2' => $e, 'shippingcity' => $f, 'shippingstate' => $g, 'shippingpostal' => $h, 'paymenttype' => $i, 'ordProducts' => $orderProducts];
    }
    $stmt->close();
?>

            <div class="row">
                <!-- Page Header -->
                <div class="col-lg-12">
                    <h2 class="page-header">Orders </h2>
                </div>
                <!--End Page Header -->
            </div>

                <!-- Welcome -->
                <div class="container">
                        <table width="100%">
                            <tr>
                                <th>Order ID</th>
                                <th>Order Email</th>
                                <th>Shipping Address</th>
                                <th>Payment Type</th>
                                <th>Status</th>
                            </tr>
                            <?php foreach($curr_orders as $ord) { ?>
                            <tr>
                                <td><a href="javascript:$('#order<?php echo $ord['orderid']; ?>').toggleClass('hide');">ORD000<?php echo $ord['orderid']; ?></a></td>
                                <td><?php echo $ord['useremail']; ?></td>
                                <td><?php echo $ord['shippingaddress1'] . ", <br>". $ord['shippingaddress2']. ", <br>". $ord['shippingcity'] . ", " .$ord['shippingstate'].", India-".$ord['shippingpostal']; ?></td>
                                <td><?php echo $ord['paymenttype']; ?></td>
                                <td><?php echo $ord['status']; ?></td>
                            </tr>
                            <tr>
                                <td colspan="5" id='order<?php echo $ord['orderid']; ?>' class='hide'>
                                    <div class="cart-items">
                                        <table width="100%">
                                            <tr>
                                              <th>Item</th>
                                              <th>Details</th>
                                              <th>Price</th>
                                            </tr>
                                        <?php foreach($ord['ordProducts'] as $prod) { ?>
                                            <tr class="cartRows">
                                              <td>
                                              <div class="cart-header">
                                               <div class="cart-item cyc">
                                                 <?php if($prod['customized'] == 0) { ?>
                                                    <img src="<?php echo SITE_URL;?>productImages/<?php echo $prod['mainimg']; ?>" class="img-responsive" alt="">
                                                 <?php }  else  { ?>
                                                 <div class="cdesign">
                                                    <?php foreach ($prod['design'] as  $des){ ?>
                                                    <div class="prd_elements" style="left: <?php echo $des['leftPos']; ?>px; top:  <?php echo $des['topPos']; ?>px;">
                                                       <img src="<?php echo SITE_URL; ?>productImages/<?php echo $des['selectedImage']; ?>">
                                                    </div>
                                                    <?php } ?>
                                                 </div>
                                                 <?php } ?>
                                              </div>
                                            </div>
                                           </td>
                                                <td>
                                                  <p><?php echo $prod['name'] ? $prod['name'] : "My Design" ; ?></p>
                                                   <p>Item ID: &nbsp;<span>PNR00<?php echo $prod['productid']; ?></span></p>
                                                    <p>Quantity: &nbsp;<span> <?php echo $prod['quantity' ]; ?></span></p>
                                                </td>
                                                <td>
                                                  <span>  &#8377; <?php echo floatval($prod['order_price']) * intval($prod['quantity']); ?></span>
                                                </td>
                                              </tr>
                                         <?php } ?>
                                        </table>
                                    </div>
                                </td>
                            </tr>
                            <?php } ?>
                        </table>
                </div>
                <!--end  Welcome -->
